# --- T2-COPYRIGHT-NOTE-BEGIN ---
# T2 SDE: package/*/linux/hotfix-execmem.patch
# Copyright (C) 2024 The T2 SDE Project
# 
# This Copyright note is generated by scripts/Create-CopyPatch,
# more information can be found in the files COPYING and README.
# 
# This patch file is dual-licensed. It is available under the license the
# patched project is licensed under, as long as it is an OpenSource license
# as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
# of the GNU General Public License version 2 as used by the T2 SDE.
# --- T2-COPYRIGHT-NOTE-END ---

Since f6bec26c0a7 (mm/execmem, arch: convert simple overrides of module_alloc to execmem)
sparc was accidentaly changed to map module memory w/ VM_FLUSH_RESET_PERMS, causing
page tables or memory corruption on each module load, making it even nearly impossible
to even successfully boot sun4u systems.

Signed-off-by: Ren√© Rebe <rene@exactcode.de>

index 0c4b36bc6d10..64404c517e93 100644
--- a/mm/execmem.c
+++ b/mm/execmem.c
@@ -17,6 +17,9 @@ static struct execmem_info default_execmem_info __ro_after_init;
 {
 	bool kasan = range->flags & EXECMEM_KASAN_SHADOW;
 	unsigned long vm_flags  = VM_FLUSH_RESET_PERMS;
+#ifdef __sparc__
+	vm_flags = 0;
+#endif
 	gfp_t gfp_flags = GFP_KERNEL | __GFP_NOWARN;
 	unsigned long start = range->start;
 	unsigned long end = range->end;
