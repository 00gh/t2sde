# --- T2-COPYRIGHT-NOTE-BEGIN ---
# T2 SDE: package/*/hyprland/hyprland.conf
# Copyright (C) 2023 The T2 SDE Project
# 
# This Copyright note is generated by scripts/Create-CopyPatch,
# more information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2.
# --- T2-COPYRIGHT-NOTE-END ---

runmake=0 runcmake=0 runmeson=0

var_append GCC_WRAPPER_INSERT ' ' "-L$root`pkgprefix libdir pixman`"

hook_add postpatch 5 hyprland_postpatch
hook_add premake 5 hyprland_premake
hook_add inmake 5 hyprland_inmake
hook_add postmake 5 hyprland_postmake

hyprland_postpatch() {
		sed -i -e 's,if(NO_XWAYLAND),set(NO_XWAYLAND true)\nif(NO_XWAYLAND),g' \
			-e '/OpenGL::GL/d' CMakeLists.txt
}

hyprland_premake() {
	echo $(pwd)

	make fixwlr
	cd subprojects

	cd wlroots && \
		meson build/ --prefix="${builddir}/tmpwlr" --buildtype=release && \
		ninja -C build/ && mkdir -p "${builddir}/tmpwlr" && \
		ninja -C build/ install && cd ..

	cd udis86 && cmake --no-warn-unused-cli -DCMAKE_BUILD_TYPE:STRING=Release \
		-H./ -B./build -G Ninja && cmake --build ./build --config Release \
		--target all -j$SDECFG_PARALLEL_MAX && cd ..

	cd ..

}

hyprland_inmake() {
	make protocols
	make release
	cd hyprctl && make all && cd ..
}

hyprland_postmake() {
	mkdir -p $root$datadir/wayland-sessions
	mkdir -p $root$datadir/hyprland
	install -m 755 build/Hyprland $root$bindir
	install -m 755 hyprctl/hyprctl $root$bindir
	install -m 644 assets/*.png $root$datadir/hyprland
	install -m 644 example/hyprland.desktop $root$datadir/wayland-sessions
	install -m 644 example/hyprland.conf $root$datadir/hyprland
	install -m 755 ../tmpwlr/lib64/libwlroots.so.12032 $root/$libdir
}
