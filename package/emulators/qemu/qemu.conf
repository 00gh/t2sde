# --- T2-COPYRIGHT-NOTE-BEGIN ---
# T2 SDE: package/*/qemu/qemu.conf
# Copyright (C) 2004 - 2024 The T2 SDE Project
# 
# This Copyright note is generated by scripts/Create-CopyPatch,
# more information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2.
# --- T2-COPYRIGHT-NOTE-END ---

runmeson=0

var_remove_regex confopt ' ' '--host=.*'
var_remove_regex makeopt ' ' 'CPP=.*'; unset CPP

if atstage cross; then
	export PKG_CONFIG=pkg-config
	var_append extraconfopt ' ' "--cross-prefix=$arch_target-"
	var_append SYSCC_WRAPPER_APPEND ' ' "$(PKG_CONFIG_PATH=$SYSPKG_CONFIG_PATH /usr/bin/pkg-config glib-2.0 --cflags --libs-only-L)"
fi

if [ "$SDECFG_PKG_QEMU_ALL" = 0 ]; then
	qemu_arch=$(echo $arch_machine | arch2uname)
	qemu_arch=${qemu_arch/i?86/i386}
	var_append extraconfopt ' ' \
		"--target-list=$qemu_arch-softmmu,$qemu_arch-linux-user"
else
	# does not build due to *64 variants
	[ "$SDECFG_LIBC" = musl ] && var_append confopt ' ' --target-list-exclude=linux-user
fi

case $arch_machine in
	alpha|hppa*|ia64)
		var_append extraconfopt ' ' --enable-tcg-interpreter ;;
	powerpc)
		# undefined reference to `_restgpr_29_x'
		var_append GCC_WRAPPER_APPEND ' ' '*/pc-bios/*?-O2:' ;;
esac
[ "$SDECFG_X8664_X32" = 1 ] && var_append extraconfopt ' ' --enable-tcg-interpreter
[ "$SDECFG_X8664_X32" = 1 ] && var_append patchfiles ' ' "$confdir/*.patch.x32"

var_append GCC_WRAPPER_INSERT ' ' "-c?:-L`pkgprefix libdir glib`"
# does not correctly locate libX11 itself
pkginstalled libx11 && var_append GCC_WRAPPER_INSERT ' ' "-c?:-L`pkgprefix libdir libx11`"
pkginstalled virglrenderer && var_append GCC_WRAPPER_INSERT ' ' "-I`pkgprefix includedir virglrenderer`"
pkginstalled alsa-lib && var_append extraconfopt ' ' '--audio-drv-list=alsa'

# Allow vm networking with "-nic user"
var_append confopt ' ' --enable-slirp
